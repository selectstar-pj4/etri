<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‘ì—…ì ê´€ë¦¬ - ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        .section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.secondary {
            background-color: #2196F3;
        }
        button.secondary:hover {
            background-color: #0b7dda;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #da190b;
        }
        .worker-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .worker-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        .worker-card h3 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
        .worker-card .info {
            font-size: 0.9rem;
            color: #666;
            margin: 5px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #4CAF50;
        }
        .message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #2196F3;
            text-decoration: none;
            font-weight: bold;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <a href="/" class="back-link">â† ì–´ë…¸í…Œì´ì…˜ íˆ´ë¡œ ëŒì•„ê°€ê¸°</a>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="adminNameDisplay" style="font-weight: bold; color: #2196F3;"></span>
                <button onclick="adminLogout()" style="padding: 8px 15px; background-color: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
        <h1>ì‘ì—…ì ê´€ë¦¬ - ê´€ë¦¬ì í˜ì´ì§€</h1>
        
        <!-- ì‘ì—…ì ëª©ë¡ -->
        <div class="section">
            <h2>ğŸ“‹ ì‘ì—…ì ëª©ë¡</h2>
            <div id="workersList" class="worker-list">
                <p>ë¡œë”© ì¤‘...</p>
            </div>
            <button onclick="loadWorkers()" class="secondary">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        
        <!-- ì‘ì—… ì§„í–‰ ìƒí™© -->
        <div class="section">
            <h2>ğŸ“Š ì‘ì—… ì§„í–‰ ìƒí™©</h2>
            <div class="form-group">
                <label>ì‘ì—…ì ì„ íƒ:</label>
                <select id="progressWorkerSelect" onchange="loadProgress()">
                    <option value="">ì‘ì—…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            <div id="progressInfo" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>í• ë‹¹ëœ ì´ë¯¸ì§€</h3>
                        <div class="value" id="progressAssigned">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ì™„ë£Œëœ ì´ë¯¸ì§€</h3>
                        <div class="value" id="progressCompleted">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ì§„í–‰ ì¤‘</h3>
                        <div class="value" id="progressInProgress">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ì™„ë£Œìœ¨</h3>
                        <div class="value" id="progressRate">0%</div>
                    </div>
                </div>
                <div class="progress-bar" style="margin-top: 20px;">
                    <div class="progress-fill" id="progressBarFill" style="width: 0%;"></div>
                </div>
            </div>
        </div>
        
        <!-- í†µê³„ ë° ë¦¬í¬íŠ¸ -->
        <div class="section">
            <h2>ğŸ“ˆ í†µê³„ ë° ë¦¬í¬íŠ¸</h2>
            <div class="form-group">
                <label>ë¦¬í¬íŠ¸ ìœ í˜•:</label>
                <select id="exportType">
                    <option value="daily">ì¼ì¼ ìš”ì•½</option>
                    <option value="detailed">ìƒì„¸ í†µê³„ (ì‹œê°„ë‹¹)</option>
                </select>
            </div>
            <div class="form-group">
                <label>ë‚ ì§œ (ì„ íƒì‚¬í•­, YYYY-MM-DD í˜•ì‹):</label>
                <input type="date" id="exportDate">
            </div>
            <button onclick="exportStats()" class="secondary">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë‚´ë³´ë‚´ê¸°</button>
            <div id="exportMessage"></div>
        </div>
        
        <!-- ì‘ì—…ìë³„ í†µê³„ -->
        <div class="section">
            <h2>ğŸ“Š ì‘ì—…ìë³„ í†µê³„</h2>
            <div class="form-group">
                <label>ì‘ì—…ì ì„ íƒ:</label>
                <select id="statsWorkerSelect" onchange="loadWorkerStats()">
                    <option value="">ì‘ì—…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            <div class="form-group">
                <label>ë‚ ì§œ (ì„ íƒì‚¬í•­):</label>
                <input type="date" id="statsDate">
                <button onclick="loadWorkerStats()" class="secondary" style="margin-top: 10px;">í†µê³„ ì¡°íšŒ</button>
            </div>
            <div id="statsInfo" style="display: none;">
                <h3>í†µê³„ ì •ë³´</h3>
                <div id="statsContent"></div>
            </div>
        </div>
    </div>
    
    <script>
        // ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ
        function adminLogout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('adminName');
                window.location.href = '/';
            }
        }
        
        // ìë™ ìƒˆë¡œê³ ì¹¨ ê°„ê²© (ë°€ë¦¬ì´ˆ)
        const AUTO_REFRESH_INTERVAL = 5000; // 5ì´ˆë§ˆë‹¤
        let autoRefreshInterval = null;
        
        // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
        function startAutoRefresh() {
            // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ì§€
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // ì£¼ê¸°ì ìœ¼ë¡œ ì‘ì—…ì ëª©ë¡ê³¼ ì§„í–‰ ìƒí™© ìƒˆë¡œê³ ì¹¨
            autoRefreshInterval = setInterval(() => {
                // ì‘ì—…ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadWorkers();
                
                // ì§„í–‰ ìƒí™©ì´ í‘œì‹œë˜ì–´ ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
                const progressWorkerId = document.getElementById('progressWorkerSelect').value;
                if (progressWorkerId) {
                    loadProgress();
                }
                
                // í†µê³„ê°€ í‘œì‹œë˜ì–´ ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
                const statsWorkerId = document.getElementById('statsWorkerSelect').value;
                if (statsWorkerId) {
                    loadWorkerStats();
                }
            }, AUTO_REFRESH_INTERVAL);
        }
        
        // ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê´€ë¦¬ì ì¸ì¦ í™•ì¸
        window.addEventListener('DOMContentLoaded', () => {
            const savedIsAdmin = localStorage.getItem('isAdmin');
            const savedAdminName = localStorage.getItem('adminName');
            
            // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
            if (savedIsAdmin !== 'true' || !savedAdminName) {
                alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/';
                return;
            }
            
            // ê´€ë¦¬ì ì´ë¦„ í‘œì‹œ
            const adminNameDisplay = document.getElementById('adminNameDisplay');
            if (adminNameDisplay) {
                adminNameDisplay.textContent = `ê´€ë¦¬ì: ${savedAdminName}`;
            }
            
            // ì‘ì—…ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            loadWorkers();
            
            // ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
            startAutoRefresh();
        });
        
        // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
        
        // ì‘ì—…ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadWorkers() {
            try {
                const response = await fetch('/api/workers');
                const data = await response.json();
                if (data.success) {
                    displayWorkers(data.workers || []);
                    updateWorkerSelects(data.workers || []);
                }
            } catch (error) {
                showMessage('workersList', 'ì‘ì—…ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        // ì‘ì—…ì ëª©ë¡ í‘œì‹œ
        function displayWorkers(workers) {
            const container = document.getElementById('workersList');
            if (workers.length === 0) {
                container.innerHTML = '<p>ë“±ë¡ëœ ì‘ì—…ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            container.innerHTML = workers.map(worker => `
                <div class="worker-card">
                    <h3>${worker.worker_id}</h3>
                    <div class="info">ì´ë¦„: ${worker.worker_name}</div>
                    <div class="info">ìƒíƒœ: ${worker.status || 'active'}</div>
                    <div class="info">ë“±ë¡ì¼: ${new Date(worker.created_at).toLocaleDateString('ko-KR')}</div>
                </div>
            `).join('');
        }
        
        // ì‘ì—…ì ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        function updateWorkerSelects(workers) {
            const selects = ['progressWorkerSelect', 'statsWorkerSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">ì‘ì—…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                    workers.forEach(worker => {
                        const option = document.createElement('option');
                        option.value = worker.worker_id;
                        option.textContent = `${worker.worker_id} - ${worker.worker_name}`;
                        select.appendChild(option);
                    });
                    if (currentValue) {
                        select.value = currentValue;
                    }
                }
            });
        }
        
        // ì§„í–‰ ìƒí™© ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadProgress() {
            const workerId = document.getElementById('progressWorkerSelect').value;
            if (!workerId) {
                document.getElementById('progressInfo').style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/workers/${workerId}/progress`);
                const data = await response.json();
                if (data.success) {
                    const progress = data.progress;
                    document.getElementById('progressAssigned').textContent = progress.assigned || 0;
                    document.getElementById('progressCompleted').textContent = progress.completed || 0;
                    document.getElementById('progressInProgress').textContent = progress.in_progress || 0;
                    document.getElementById('progressRate').textContent = (progress.completion_rate || 0).toFixed(1) + '%';
                    document.getElementById('progressBarFill').style.width = (progress.completion_rate || 0) + '%';
                    document.getElementById('progressInfo').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load progress:', error);
            }
        }
        
        // í†µê³„ ë‚´ë³´ë‚´ê¸°
        async function exportStats() {
            const type = document.getElementById('exportType').value;
            const date = document.getElementById('exportDate').value;
            const messageDiv = document.getElementById('exportMessage');
            
            try {
                let url = `/api/workers/export?type=${type}`;
                if (date) {
                    url += `&date=${date}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    let message = `ìŠ¤í”„ë ˆë“œì‹œíŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${data.local_file}`;
                    if (data.drive_link) {
                        message += `\nGoogle Drive: ${data.drive_link}`;
                    }
                    showMessage('exportMessage', message, 'success');
                } else {
                    showMessage('exportMessage', data.error || 'ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                showMessage('exportMessage', 'ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                console.error(error);
            }
        }
        
        // ì‘ì—…ì í†µê³„ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadWorkerStats() {
            const workerId = document.getElementById('statsWorkerSelect').value;
            const date = document.getElementById('statsDate').value;
            
            if (!workerId) {
                document.getElementById('statsInfo').style.display = 'none';
                return;
            }
            
            try {
                let url = `/api/workers/${workerId}/stats`;
                if (date) {
                    url += `?date=${date}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    const content = document.getElementById('statsContent');
                    
                    let html = `<p><strong>ì´ ì™„ë£Œ ìˆ˜:</strong> ${stats.total_completed || 0}</p>`;
                    
                    if (stats.daily_stats && Object.keys(stats.daily_stats).length > 0) {
                        html += '<h4>ì¼ì¼ í†µê³„:</h4><table><tr><th>ë‚ ì§œ</th><th>ì™„ë£Œ ìˆ˜</th></tr>';
                        for (const [date, count] of Object.entries(stats.daily_stats)) {
                            html += `<tr><td>${date}</td><td>${count}</td></tr>`;
                        }
                        html += '</table>';
                    }
                    
                    if (stats.hourly_stats && Object.keys(stats.hourly_stats).length > 0) {
                        html += '<h4>ì‹œê°„ë‹¹ í†µê³„:</h4><table><tr><th>ì‹œê°„</th><th>ì™„ë£Œ ìˆ˜</th></tr>';
                        for (const [hour, count] of Object.entries(stats.hourly_stats)) {
                            html += `<tr><td>${hour}</td><td>${count}</td></tr>`;
                        }
                        html += '</table>';
                    }
                    
                    content.innerHTML = html;
                    document.getElementById('statsInfo').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }
        
        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>

